name: CI

on:
  push:

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10.x

permissions:
  actions: read
  contents: read

jobs:
  lint:
    name: üéâ ESLint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Environment and Install Dependencies
        uses: ./.github/actions/setup-deps
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Run ESLint
        run: pnpm lint

  test:
    name: üß™ Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Environment and Install Dependencies
        uses: ./.github/actions/setup-deps
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Run Tests
        run: pnpm test

  typecheck:
    name: üîç TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Environment and Install Dependencies
        uses: ./.github/actions/setup-deps
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Run TypeScript Type Check
        run: pnpm typecheck

  build:
    name: üì¶ Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Environment and Install Dependencies
        uses: ./.github/actions/setup-deps
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Run Build
        run: pnpm build:check
      - name: Nx Self-healing (analyze failures)
        if: always()
        run: pnpm nx fix-ci
